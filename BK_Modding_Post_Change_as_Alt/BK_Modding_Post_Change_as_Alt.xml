<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<!-- This package was generated by SleePys Modification Maker at http://sleepycode.com -->
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>BK_Modding:Post_Change_as_Alt</id>
	<version>1.5</version>

	<file name="$languagedir/ManagePermissions.english.php">
		<operation>
			<search position="end" />
			<add><![CDATA[
$txt['permissionname_reply_alternate'] = 'Can reply as an alternate user';
$txt['permissionhelp_reply_alternate'] = 'Allow user to post as an alternate user.';]]></add>
		</operation>
	</file>

	<file name="$languagedir/Modifications.english.php">
		<operation>
			<search position="end" />
			<add><![CDATA[$txt['changeposterid'] = 'Change Poster/Starter';
$txt['changeposteridno'] = 'Poster ID';
$txt['adminscanpostasaltuser'] = 'Post/Edit As Alternative User';
$txt['adminspostasguestcalled'] = 'Forum Staff';
$txt['adminscanpostasaltuserid'] = 'Alternative User ID';
]]></add>
		</operation>
	</file>

	<file name="$languagedir/ManagePermissions.english-utf8.php" error="skip">
		<operation>
			<search position="end" />
			<add><![CDATA[
$txt['permissionname_reply_alternate'] = 'Can reply as an alternate user';
$txt['permissionhelp_reply_alternate'] = 'Allow user to post as an alternate user.';]]></add>
		</operation>
	</file>

	<file name="$languagedir/Modifications.english-uft8.php" error="skip">
		<operation>
			<search position="end" />
			<add><![CDATA[$txt['changeposterid'] = 'Change Poster/Starter';
$txt['changeposteridno'] = 'Poster ID';
$txt['adminscanpostasaltuser'] = 'Post/Edit As Alternative User';
$txt['adminspostasguestcalled'] = 'Forum Staff';
$txt['adminscanpostasaltuserid'] = 'Alternative User ID';
]]></add>
			</operation>
	</file>

	<file name="$sourcedir/ManagePermissions.php">
		<operation>
			<search position="replace"><![CDATA[			'post' => array(
				'delete' => true,
				'modify' => true,]]></search>
			<add><![CDATA[			'post' => array(
				'delete' => true,
				'modify' => true,
				'reply_alternate' => false,]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Post.php">
		<operation>
			<search position="replace"><![CDATA[			$msgOptions['modify_name'] = addslashes($user_info['name']);]]></search>
			<add><![CDATA[			if (isset($_POST['postasforumstaff']) && (allowedto('reply_alternate')))
			{
				// ENSURE ALT USER ID IS AN INTEGER
				$staffid = !empty($_POST['staffid']) ? (int) $_POST['staffid'] : 0 ;
				// USER ID = 0, POST AS GUEST
				if ($staffid == 0)
				{
					$msgOptions['modify_name'] = addslashes($txt['adminspostasguestcalled']);
				} elseif($staffid > 0) {
					
					// QUERY DB TO GET NAME OF USER
					$request = db_query("
						SELECT memberName
						FROM {$db_prefix}members
						WHERE ID_MEMBER = ".$staffid."
						LIMIT 1", __FILE__, __LINE__);
					
					// FOUND USER WANTING TO POST AS
					if (mysql_num_rows($request) != 0)
					{
						list ($msgOptions['modify_name']) = mysql_fetch_row($request);
						mysql_free_result($request);
					} else {
						// NOPE, DOESNT EXIST (ANYMORE?) SO BE A GUEST
						$msgOptions['modify_name'] = addslashes($txt['adminspostasguestcalled']);
					}
				} else {
					// shouldnt have reached here, so proceed as normal post
					$msgOptions['modify_name'] = addslashes($user_info['name']);
				}
			} else {
				// proceed as normal
				$msgOptions['modify_name'] = addslashes($user_info['name']);
			}]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-Post.php">
		<operation>
			<search position="replace"><![CDATA[function modifyPost(&$msgOptions, &$topicOptions, &$posterOptions)
{
	global $db_prefix, $user_info, $ID_MEMBER, $modSettings;]]></search>
			<add><![CDATA[function modifyPost(&$msgOptions, &$topicOptions, &$posterOptions)
{
	global $db_prefix, $user_info, $ID_MEMBER, $modSettings, $context;]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[	// Change the post.
	db_query("
		UPDATE {$db_prefix}messages
		SET " . implode(', ', $messages_columns) . "
		WHERE ID_MSG = $msgOptions[id]
		LIMIT 1", __FILE__, __LINE__);
]]></search>
			<add><![CDATA[	if(isset($_POST['changeposterid']) && $context['user']['is_admin'])
	{
		//Make sure it is an integer.
		$changeposteridno = !empty($_POST['changeposteridno']) ? (int) $_POST['changeposteridno'] : 0 ;

		//Should be greater than zero, no negative ids.
		if($changeposteridno > 0)
		{
			//Check if the id exists.
			$request = db_query("
				SELECT ID_MEMBER, memberName, emailAddress, memberIP	
				FROM {$db_prefix}members
				WHERE ID_MEMBER = ".$changeposteridno."
				LIMIT 1", __FILE__, __LINE__);

			if (mysql_num_rows($request) != 0)
			{
				//Change poster information.
				while ($row = mysql_fetch_assoc($request))
				{
				db_query("
					UPDATE {$db_prefix}messages
					SET ID_MEMBER = ".$changeposteridno.", posterName = '".$row['memberName']."', posterEmail = '".$row['emailAddress']."', posterIP = '".$row['memberIP']."' 
					WHERE ID_MSG = $msgOptions[id]
					LIMIT 1", __FILE__, __LINE__);
				}
				mysql_free_result($request);

				//If it is topic, we should modify topic too.
				$request = db_query("
					SELECT ID_TOPIC
					FROM {$db_prefix}topics
					WHERE ID_FIRST_MSG = $msgOptions[id]
					LIMIT 1", __FILE__, __LINE__);

				//Found it! Change the starter id.
				if (mysql_num_rows($request) == 1)
				{
				db_query("
					UPDATE {$db_prefix}topics
					SET ID_MEMBER_STARTED = ".$changeposteridno."
					WHERE ID_FIRST_MSG = $msgOptions[id]
					LIMIT 1", __FILE__, __LINE__);
				}
				mysql_free_result($request);

			}
		}
	}

]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[	// If nothing was filled in as name/e-mail address, try the member table.]]></search>
			<add><![CDATA[		if(isset($_POST['postasforumstaff']) && (allowedto('reply_alternate')))
		{
			// check variable exists or make it to avoid error
			$staffid = !empty($_POST['staffid']) ? (int) $_POST['staffid'] : 0 ;
			// default selected, post as guest
			if ($staffid == 0)
			{
				$posterOptions['name'] = $txt['adminspostasguestcalled'];
				$posterOptions['id'] = 0;
				$posterOptions['ip'] = '0.0.0.0';
				$posterOptions['email'] = '';
			} elseif($staffid > 0) {
				// QUERY DB TO GET NAME OF USER
				$request = db_query("
					SELECT ID_MEMBER
					FROM {$db_prefix}members
					WHERE ID_MEMBER = ".$staffid."
					LIMIT 1", __FILE__, __LINE__);
					
				// FOUND USER WANTING TO POST AS
				if (mysql_num_rows($request) != 0)
				{
					$posterOptions['id'] = $staffid;				
					$posterOptions['ip'] = '0.0.0.0';
					$posterOptions['email'] = '';
					unset($posterOptions['name']);
					mysql_free_result($request);
					
				} else {
					// NOPE, DOESNT EXIST (ANYMORE?) SO BE A GUEST
					$posterOptions['name'] = $txt['adminspostasguestcalled'];
					$posterOptions['id'] = 0;
					$posterOptions['ip'] = '0.0.0.0';
					$posterOptions['email'] = '';
				
				}
			} else{
				// oops, something should not get this far?
				// proceed as normal
			}
		}
		
]]></add>
		</operation>
	</file>

	<file name="$themedir/Post.template.php">
		<operation>
			<search position="replace"><![CDATA[													</tr>' : '', '
												</table>
											</div>
										</td>
									</tr>';]]></search>
			<add><![CDATA[													</tr>' : '';
									if (allowedto('reply_alternate'))
									{
										echo '	<tr>
														<td class="smalltext"><label for="check_postasforumstaff"><input type="checkbox" name="postasforumstaff" id="postasforumstaff" value="1" class="check" /> '.$txt['adminscanpostasaltuser'].'</label></td>
														<td class="smalltext"><label for="text_staffid">'.$txt['adminscanpostasaltuserid'].': <input type="text" name="staffid" id="staffid" size="5" /></label></td>
							          </tr>';
									}
									if ($context['user']['is_admin'] && isset($_REQUEST['msg']))
									{
										echo '	<tr>
														<td class="smalltext"><label for="check_changeposterid"><input type="checkbox" name="changeposterid" id="changeposterid" value="1" class="check" /> '.$txt['changeposterid'].'</label></td>
														<td class="smalltext"><label for="text_changeposteridno">'.$txt['changeposteridno'].': <input type="text" name="changeposteridno" id="changeposteridno" size="5" /></label></td>
												</tr>';
									}
							echo '		</table>
											</div>
										</td>
									</tr>';]]></add>
		</operation>
	</file>
</modification>